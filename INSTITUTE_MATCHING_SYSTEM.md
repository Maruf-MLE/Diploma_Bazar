# Institute Matching System

## рж╕рж┐рж╕рзНржЯрзЗржо Overview

ржПржЗ рж╕рж┐рж╕рзНржЯрзЗржорзЗрж░ ржорж╛ржзрзНржпржорзЗ рж╢рзБржзрзБржорж╛рждрзНрж░ ржПржХржЗ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржЫрж╛рждрзНрж░ржЫрж╛рждрзНрж░рзАрж░рж╛ ржПржХрзЗ ржЕржкрж░рзЗрж░ рж╕рж╛ржерзЗ ржпрзЛржЧрж╛ржпрзЛржЧ ржХрж░рждрзЗ ржПржмржВ ржмржЗ ржХрж┐ржирждрзЗ ржкрж╛рж░ржмрзЗред

## ржпрж╛ ржпрж╛ implement ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ:

### рзз. Database Level Security

#### Functions рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ:
- `users_same_institute(user1_id, user2_id)` - ржжрзБржЗ ржЗржЙржЬрж╛рж░ ржПржХржЗ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзЗ
- `can_message_user(sender_id, receiver_id)` - ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛ ржпрж╛ржмрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзЗ
- `can_purchase_book(buyer_id, book_id)` - ржмржЗ ржХрзЗржирж╛рж░ ржЕржирзБрж░рзЛржз ржкрж╛ржарж╛ржирзЛ ржпрж╛ржмрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзЗ
- `get_user_institute(user_id)` - ржЗржЙржЬрж╛рж░рзЗрж░ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржирж╛ржо ржжрзЗржпрж╝
- `current_user_same_institute(other_user_id)` - ржмрж░рзНрждржорж╛ржи ржЗржЙржЬрж╛рж░ ржЕржирзНржп ржЗржЙржЬрж╛рж░рзЗрж░ рж╕рж╛ржерзЗ ржПржХржЗ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржХрж┐ржирж╛

#### RLS Policies ржЖржкржбрзЗржЯ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ:
- **Messages Table**: рж╢рзБржзрзБ ржПржХржЗ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржЗржЙржЬрж╛рж░рж░рж╛ ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛рждрзЗ ржкрж╛рж░ржмрзЗ
- **Purchase Requests Table**: рж╢рзБржзрзБ ржПржХржЗ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржЗржЙржЬрж╛рж░рж░рж╛ ржмржЗ ржХрзЗржирж╛рж░ ржЕржирзБрж░рзЛржз ржкрж╛ржарж╛рждрзЗ ржкрж╛рж░ржмрзЗ

### рзи. Frontend Level Validation

#### Utility Functions:
- `canMessageUser(receiverId)` - ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛ ржпрж╛ржмрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ
- `canPurchaseBook(bookId)` - ржмржЗ ржХрзЗржирж╛рж░ ржЕржирзБрж░рзЛржз ржкрж╛ржарж╛ржирзЛ ржпрж╛ржмрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ
- `usersSameInstitute(user1Id, user2Id)` - ржжрзБржЗ ржЗржЙржЬрж╛рж░ ржПржХржЗ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржХрж┐ржирж╛
- `currentUserSameInstitute(otherUserId)` - ржмрж░рзНрждржорж╛ржи ржЗржЙржЬрж╛рж░ ржЕржирзНржп ржЗржЙржЬрж╛рж░рзЗрж░ рж╕рж╛ржерзЗ ржПржХржЗ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржХрж┐ржирж╛
- `getUserInstitute(userId)` - ржЗржЙржЬрж╛рж░рзЗрж░ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржи

#### Error Messages:
```typescript
const INSTITUTE_MISMATCH_MESSAGES = {
  MESSAGE: 'ржЖржкржирж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ ржЖржкржирж╛рж░ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржЫрж╛рждрзНрж░ржЫрж╛рждрзНрж░рзАржжрзЗрж░ рж╕рж╛ржерзЗ ржорзЗрж╕рзЗржЬ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред',
  PURCHASE: 'ржЖржкржирж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ ржЖржкржирж╛рж░ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржЫрж╛рждрзНрж░ржЫрж╛рждрзНрж░рзАржжрзЗрж░ ржХрж╛ржЫ ржерзЗржХрзЗ ржмржЗ ржХрж┐ржирждрзЗ ржкрж╛рж░ржмрзЗржиред',
  GENERAL: 'ржПржЗ ржХрж╛рж░рзНржпржХрзНрж░ржоржЯрж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ ржПржХржЗ ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржЫрж╛рждрзНрж░ржЫрж╛рждрзНрж░рзАржжрзЗрж░ ржоржзрзНржпрзЗ рж╕рзАржорж╛ржмржжрзНржзред'
}
```

### рзй. UI Level Integration

#### BookDetailsDialog ржЖржкржбрзЗржЯ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ:
- **Contact Seller Button**: ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛрж░ ржЖржЧрзЗ institute matching ржЪрзЗржХ ржХрж░рзЗ
- **Purchase Request Button**: ржмржЗ ржХрзЗржирж╛рж░ ржЕржирзБрж░рзЛржз ржкрж╛ржарж╛ржирзЛрж░ ржЖржЧрзЗ institute matching ржЪрзЗржХ ржХрж░рзЗ
- **Error Messages**: ржпржжрж┐ institute match ржирж╛ ржХрж░рзЗ рждрж╛рж╣рж▓рзЗ ржмрж╛ржВрж▓рж╛ржпрж╝ error message ржжрзЗржЦрж╛ржпрж╝

## Setup Instructions:

### рзз. Database Setup:
```bash
# Supabase SQL Editor ржП ржПржЗ file ржЪрж╛рж▓рж╛ржи:
institute_matching_system.sql
```

### рзи. Frontend Integration:
- `instituteUtils.ts` file ржЗрждрж┐ржоржзрзНржпрзЗ рждрзИрж░рж┐ рж╣ржпрж╝рзЗ ржЧрзЗржЫрзЗ
- `BookDetailsDialog.tsx` ржЖржкржбрзЗржЯ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ

## ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ:

### Message ржкрж╛ржарж╛ржирзЛрж░ рж╕ржоржпрж╝:
1. User "ржмрж┐ржХрзНрж░рзЗрждрж╛рж░ рж╕рж╛ржерзЗ ржпрзЛржЧрж╛ржпрзЛржЧ ржХрж░рзБржи" button ржП click ржХрж░рзЗ
2. System check ржХрж░рзЗ ржжрзБржЗ user ржПржХржЗ institute ржПрж░ ржХрж┐ржирж╛
3. ржпржжрж┐ ржПржХржЗ institute ржирж╛ рж╣ржпрж╝ рждрж╛рж╣рж▓рзЗ error message ржжрзЗржЦрж╛ржпрж╝
4. ржпржжрж┐ ржПржХржЗ institute рж╣ржпрж╝ рждрж╛рж╣рж▓рзЗ message dialog open ржХрж░рзЗ

### Purchase Request ржкрж╛ржарж╛ржирзЛрж░ рж╕ржоржпрж╝:
1. User "ржмржЗ ржХрзЗржирж╛рж░ ржЕржирзБрж░рзЛржз ржкрж╛ржарж╛ржи" button ржП click ржХрж░рзЗ  
2. System check ржХрж░рзЗ buyer ржУ seller ржПржХржЗ institute ржПрж░ ржХрж┐ржирж╛
3. ржпржжрж┐ ржПржХржЗ institute ржирж╛ рж╣ржпрж╝ рждрж╛рж╣рж▓рзЗ error message ржжрзЗржЦрж╛ржпрж╝
4. ржпржжрж┐ ржПржХржЗ institute рж╣ржпрж╝ рждрж╛рж╣рж▓рзЗ purchase request form open ржХрж░рзЗ

### Database Level Protection:
- RLS policies ensure ржХрж░рзЗ ржпрзЗ database level ржПржУ ржПржЗ restrictions ржХрж╛ржЬ ржХрж░рзЗ
- ржпржжрж┐ ржХрзЗржЙ API directly call ржХрж░рзЗ рждрж╛рж╣рж▓рзЗржУ system prevent ржХрж░ржмрзЗ

## Testing:

### Test Case 1: Same Institute Users
1. ржПржХржЗ institute ржПрж░ ржжрзБржЗ user create ржХрж░рзБржи
2. ржПржХржЬржи ржмржЗ post ржХрж░рзБржи
3. ржЕржирзНржпржЬржи рж╕рзЗржЗ ржмржЗ ржП message/purchase request ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржи
4. **Expected**: Successfully message/purchase request ржкрж╛ржарж╛рждрзЗ ржкрж╛рж░ржмрзЗ

### Test Case 2: Different Institute Users  
1. ржнрж┐ржирзНржи institute ржПрж░ ржжрзБржЗ user create ржХрж░рзБржи
2. ржПржХржЬржи ржмржЗ post ржХрж░рзБржи
3. ржЕржирзНржпржЬржи рж╕рзЗржЗ ржмржЗ ржП message/purchase request ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржи
4. **Expected**: Error message ржжрзЗржЦрж╛ржмрзЗ ржПржмржВ action prevent ржХрж░ржмрзЗ

## Security Features:

1. **Double Layer Protection**: Frontend validation + Database RLS policies
2. **SQL Injection Prevention**: Parameterized queries ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ
3. **Role-based Access**: рж╢рзБржзрзБ authenticated users рж░рж╛ functions access ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
4. **Data Integrity**: Institute name null check ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ

## Maintenance:

### ржирждрзБржи Institute Add ржХрж░рждрзЗ:
- рж╢рзБржзрзБ profiles table ржП correct institute_name ржжрж┐рж▓рзЗржЗ рж╣ржмрзЗ
- ржХрзЛржирзЛ additional configuration рж▓рж╛ржЧржмрзЗ ржирж╛

### Disable ржХрж░рждрзЗ ржЪрж╛ржЗрж▓рзЗ:
```sql
-- RLS policies disable ржХрж░рзБржи
DROP POLICY "Allow users to send messages to same institute users" ON public.messages;
DROP POLICY "Allow buyers to create purchase requests for same institute sellers" ON public.purchase_requests;

-- Original policies restore ржХрж░рзБржи
-- (ржЖржкржирж╛рж░ ржЖржЧрзЗрж░ policies ржПрж░ backup ржирж┐ржпрж╝рзЗ рж░рж╛ржЦрзБржи)
```

ржПржЦржи ржЖржкржирж╛рж░ рж╕рж┐рж╕рзНржЯрзЗржо рж╕ржорзНржкрзВрж░рзНржгржнрж╛ржмрзЗ institute-based access control ржжрж┐ржпрж╝рзЗ secure! ЁЯПлЁЯФТ
